From 44a78295f9fea7bc6935c5f6975fbaab8616c9a3 Mon Sep 17 00:00:00 2001
From: Dillibabu <dillibabug@ami.com>
Date: Mon, 26 Feb 2024 11:45:45 +0530
Subject: [PATCH] 1. Added IPV6 suppport to library. 2. fixed core-dump issue
 on headers.c file (struct time varaible required typecasting).

Signed-off-by: Dillibabu <dillibabug@ami.com>
---
 headers.c   |  2 +-
 libesmtp.h  |  1 +
 meson.build |  2 +-
 smtp-api.c  | 22 ++++++++++++++++++++++
 4 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/headers.c b/headers.c
index cbcee31..0045278 100644
--- a/headers.c
+++ b/headers.c
@@ -170,7 +170,7 @@ print_message_id (smtp_message_t message, struct rfc2822_header *header)
     {
 #ifdef HAVE_GETTIMEOFDAY
       if (gettimeofday (&tv, NULL) != -1) /* This shouldn't fail ... */
-	snprintf (buf, sizeof buf, "%ld.%ld.%d@%s", tv.tv_sec, tv.tv_usec,
+	snprintf (buf, sizeof buf, "%ld.%ld.%d@%s", (long int)tv.tv_sec, (long int)tv.tv_usec,
 		  getpid (), message->session->localhost);
       else /* ... but if it does fall back to using time() */
 #endif
diff --git a/libesmtp.h b/libesmtp.h
index f37ac42..c3c25bf 100644
--- a/libesmtp.h
+++ b/libesmtp.h
@@ -83,6 +83,7 @@ int smtp_enumerate_messages (smtp_session_t session,
 int smtp_set_server (smtp_session_t session, const char *hostport);
 const char *smtp_get_server_name (smtp_session_t session);
 int smtp_set_hostname (smtp_session_t session, const char *hostname);
+int smtp_set_ipv6_server (smtp_session_t session, const char *service, const char *host);
 int smtp_set_reverse_path (smtp_message_t message, const char *mailbox);
 smtp_recipient_t smtp_add_recipient (smtp_message_t message,
                                      const char *mailbox);
diff --git a/meson.build b/meson.build
index 04e24e4..1f4bb0d 100644
--- a/meson.build
+++ b/meson.build
@@ -117,7 +117,7 @@ conf.set('HAVE_LIBCRYPTO', ssldep.found().to_int())
 conf.set('HAVE_LOCALTIME_R', 1, description : 'SUSV2')
 conf.set('HAVE_LWRES_NETDB_H', lwresdep.found().to_int())
 conf.set('HAVE_STRERROR_R', 1)
-conf.set('HAVE_WORKING_STRERROR_R', 0)
+conf.set('HAVE_WORKING_STRERROR_R', 1)
 conf.set('HAVE_STRUCT_TM_TM_ZONE', 0)
 conf.set('HAVE_UNAME', 1)
 conf.set('HAVE_STRFTIME', 1)
diff --git a/smtp-api.c b/smtp-api.c
index b05ff3a..3b6d7d3 100644
--- a/smtp-api.c
+++ b/smtp-api.c
@@ -129,6 +129,28 @@ smtp_set_server (smtp_session_t session, const char *hostport)
   return 1;
 }
 
+/**
+* smtp_set_ipv6_server() - set IPV6 IP address to session.
+* @session: The session.
+* @service: port number
+* @host: IPV6 ip address of smtp server.
+* assing IPV6 address to session.
+* Return: 1 for success or 0.
+*/
+
+int smtp_set_ipv6_server (smtp_session_t session, const char *service, const char *host)
+{
+
+  if (session->canon != NULL)
+       free (session->canon);
+
+  session->canon = NULL;
+  session->port = service;
+  session->host = host;
+
+ return 1;
+}
+
 /**
  * smtp_get_server_name() - get submission MTA canonic hostname.
  * @session: The session.
-- 
2.34.1

