From d4f6f2c5e9eeaf7f4f43dfaf5a4f7cd6ecf5c961 Mon Sep 17 00:00:00 2001
From: arjuncr <arjuncr@ami.com>
Date: Tue, 24 Oct 2023 13:56:18 -0400
Subject: [PATCH] Fix for Nm Sensor Threshold

Signed-off-by: arjuncr <arjuncr@ami.com>
---
 src/IntelCPUSensorMain.cpp | 4 ++--
 src/Thresholds.cpp         | 4 ++++
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/IntelCPUSensorMain.cpp b/src/IntelCPUSensorMain.cpp
index 0b63a672..bb82cf75 100644
--- a/src/IntelCPUSensorMain.cpp
+++ b/src/IntelCPUSensorMain.cpp
@@ -113,7 +113,7 @@ static constexpr auto hiddenProps{std::to_array<const char*>(
 static const boost::container::flat_map<std::string, SensorProperties>
     sensorPropertiesMap = {
         {"power",
-         {"/xyz/openbmc_project/sensors/power/", sensor_paths::unitWatts, 511,
+         {"/xyz/openbmc_project/sensors/power/", sensor_paths::unitWatts, 4500,
           0, 1000}},
         {"energy",
          {"/xyz/openbmc_project/sensors/energy/", sensor_paths::unitJoules,
@@ -334,7 +334,7 @@ bool createSensors(boost::asio::io_context& io,
         auto directory = hwmonNamePath.parent_path();
         std::vector<fs::path> inputPaths;
         if (!findFiles(directory,
-                       R"((temp|power|energy)\d+_(input|average|cap_min|cap_max|cap)$)",
+                       R"((temp|power|energy)\d+_(input|average|cap)$)",
                        inputPaths, 0))
         {
             std::cerr << "No CPU sensors in system\n";
diff --git a/src/Thresholds.cpp b/src/Thresholds.cpp
index b54b9170..7d65940c 100644
--- a/src/Thresholds.cpp
+++ b/src/Thresholds.cpp
@@ -560,6 +560,10 @@ bool parseThresholdsFromAttr(
                  std::make_tuple("crit", Level::CRITICAL, Direction::HIGH,
                                  offset),
              }},
+	    {"cap",
+             {
+                 std::make_tuple("cap_max", Level::WARNING, Direction::HIGH, 0.0),
+             }},
         };
 
     if (auto fileParts = splitFileName(inputPath))
-- 
2.34.1

