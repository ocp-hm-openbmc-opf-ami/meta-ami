From 39efba60aeba2539611cabd13c55c97547b7cafb Mon Sep 17 00:00:00 2001
From: prasannas <prasannas@ami.com>
Date: Mon, 28 Aug 2023 17:21:59 +0530
Subject: [PATCH 2421/2421] Adding Error Message for Invalid HostName

---
 redfish-core/lib/ethernet.hpp | 57 +++++++++++++++++++++++--------------------
 1 file changed, 31 insertions(+), 26 deletions(-)

diff --git a/redfish-core/lib/ethernet.hpp b/redfish-core/lib/ethernet.hpp
index 11cb5a5..0d42372 100644
--- a/redfish-core/lib/ethernet.hpp
+++ b/redfish-core/lib/ethernet.hpp
@@ -887,6 +887,32 @@ void getEthernetIfaceList(CallbackFunc&& callback)
         callback(true, ifaceList);
         });
 }
+inline bool isHostnameValid(const std::string& hostname)
+{
+    // A valid host name can never have the dotted-decimal form (RFC 1123)
+    if (std::all_of(hostname.begin(), hostname.end(), ::isdigit))
+    {
+        return false;
+    }
+    // Each label(hostname/subdomains) within a valid FQDN
+    // MUST handle host names of up to 63 characters (RFC 1123)
+    // labels cannot start or end with hyphens (RFC 952)
+    // labels can start with numbers (RFC 1123)
+    const std::regex pattern(
+        "^[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9]$");
+
+    return std::regex_match(hostname, pattern);
+}
+
+inline bool isDomainnameValid(const std::string& domainname)
+{
+    // Can have multiple subdomains
+    // Top Level Domain's min length is 2 character
+    const std::regex pattern(
+        "^([A-Za-z0-9][a-zA-Z0-9\\-]{1,61}|[a-zA-Z0-9]{1,30}\\.)*[a-zA-Z]{2,}$");
+
+    return std::regex_match(domainname, pattern);
+}
 
 inline void
     handleHostnamePatch(const std::string& hostname,
@@ -899,6 +925,11 @@ inline void
                                            "HostName");
         return;
     }
+    if (!isHostnameValid(hostname))
+    {
+        messages::propertyValueFormatError(asyncResp->res, hostname,"HostName");
+        return;
+    }
     crow::connections::systemBus->async_method_call(
         [asyncResp](const boost::system::error_code& ec) {
         if (ec)
@@ -951,32 +982,6 @@ inline void
         dbus::utility::DbusVariantType(vectorDomainname));
 }
 
-inline bool isHostnameValid(const std::string& hostname)
-{
-    // A valid host name can never have the dotted-decimal form (RFC 1123)
-    if (std::all_of(hostname.begin(), hostname.end(), ::isdigit))
-    {
-        return false;
-    }
-    // Each label(hostname/subdomains) within a valid FQDN
-    // MUST handle host names of up to 63 characters (RFC 1123)
-    // labels cannot start or end with hyphens (RFC 952)
-    // labels can start with numbers (RFC 1123)
-    const std::regex pattern(
-        "^[a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\\-]{0,61}[a-zA-Z0-9]$");
-
-    return std::regex_match(hostname, pattern);
-}
-
-inline bool isDomainnameValid(const std::string& domainname)
-{
-    // Can have multiple subdomains
-    // Top Level Domain's min length is 2 character
-    const std::regex pattern(
-        "^([A-Za-z0-9][a-zA-Z0-9\\-]{1,61}|[a-zA-Z0-9]{1,30}\\.)*[a-zA-Z]{2,}$");
-
-    return std::regex_match(domainname, pattern);
-}
 
 inline void handleFqdnPatch(const std::string& ifaceId, const std::string& fqdn,
                             const std::shared_ptr<bmcweb::AsyncResp>& asyncResp)
-- 
2.9.5

