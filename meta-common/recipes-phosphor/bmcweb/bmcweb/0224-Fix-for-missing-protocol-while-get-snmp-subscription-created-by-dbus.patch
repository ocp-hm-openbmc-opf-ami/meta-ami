From a5d42e76c38666f1d95f55b67923da098f2e022c Mon Sep 17 00:00:00 2001
From: muthulakshmin <muthulakshmin@ami.com>
Date: Mon, 18 Mar 2024 16:06:06 +0530
Subject: [PATCH 224/224] Fix for missing protocol while get snmp subscription
 created by dbus

Signed-off-by: MuthuLakshmiN <muthulakshmin@ami.com>
---
 .../include/snmp_trap_event_clients.hpp       | 26 ++++++++++++++++++-
 1 file changed, 25 insertions(+), 1 deletion(-)

diff --git a/redfish-core/include/snmp_trap_event_clients.hpp b/redfish-core/include/snmp_trap_event_clients.hpp
index a04a9277..e9a571ba 100644
--- a/redfish-core/include/snmp_trap_event_clients.hpp
+++ b/redfish-core/include/snmp_trap_event_clients.hpp
@@ -97,7 +97,31 @@ inline void
     }
     else
     {
-        asyncResp->res.jsonValue["Context"] = "";
+        size_t pos = id.find("snmp");
+
+        std::string snmpid;
+        if (pos != std::string::npos)
+        {
+            // Extract the data after "snmp"
+            snmpid = id.substr(pos + 4); 
+        }
+        std::string protocol = "SNMP";
+        sdbusplus::asio::getProperty<std::string>(
+            *crow::connections::systemBus, "xyz.openbmc_project.Network.SNMP",
+            "/xyz/openbmc_project/network/snmp/manager/" + snmpid,
+            "xyz.openbmc_project.Network.Client", "Version",
+            [asyncResp, protocol](const boost::system::error_code& ec,
+                                  const std::string& version) {
+            if (ec)
+            {
+                BMCWEB_LOG_DEBUG("DBUS response error {}", ec);
+                messages::internalError(asyncResp->res);
+                return;
+            }
+            asyncResp->res.jsonValue["Protocol"] = protocol + version;
+            asyncResp->res.jsonValue["Context"] = "";
+        });
+        //asyncResp->res.jsonValue["Context"] = "";
     }
 
     sdbusplus::asio::getAllProperties(
-- 
2.34.1

