From 2f861ca58e4a7bd0f609445d8ad82f94956d0f14 Mon Sep 17 00:00:00 2001
From: Pranoy Goru <gorumanip@ami.com>
Date: Sat, 14 Oct 2023 00:35:11 +0530
Subject: [PATCH 15/15] added OEM led-indicator amber green susack status

---
 redfish-core/lib/led.hpp     | 77 ++++++++++++++++++++++++++++++++++++
 redfish-core/lib/systems.hpp |  1 +
 2 files changed, 78 insertions(+)

diff --git a/redfish-core/lib/led.hpp b/redfish-core/lib/led.hpp
index ff77ddc1..ac9fb05c 100644
--- a/redfish-core/lib/led.hpp
+++ b/redfish-core/lib/led.hpp
@@ -252,4 +252,81 @@ inline void setLocationIndicatorActive(
         }
     });
 }
+
+inline void setPhysicalLedState(const std::shared_ptr<bmcweb::AsyncResp>& aResp,
+                                const std::string& led,
+                                const std::string& state)
+{
+    if (boost::ends_with(state, "On"))
+    {
+        aResp->res.jsonValue["Oem"]["OpenBmc"]["PhysicalLED"][led] = "On";
+    }
+    else if (boost::ends_with(state, "Blink"))
+    {
+        aResp->res.jsonValue["Oem"]["OpenBmc"]["PhysicalLED"][led] = "Blinking";
+    }
+    else if (boost::ends_with(state, "Off"))
+    {
+        aResp->res.jsonValue["Oem"]["OpenBmc"]["PhysicalLED"][led] = "Off";
+    }
+    else
+    {
+        aResp->res.jsonValue["Oem"]["OpenBmc"]["PhysicalLED"][led] = "Unknown";
+    }
+}
+
+inline void getPhysicalLedState(const std::shared_ptr<bmcweb::AsyncResp>& aResp)
+{
+    BMCWEB_LOG_DEBUG << "Get Physical Led";
+    aResp->res.jsonValue["Oem"]["OpenBmc"]["PhysicalLED"]["@odata.type"] =
+        "#OemComputerSystem.PhysicalLED";
+
+    sdbusplus::asio::getProperty<std::string>(
+        *crow::connections::systemBus,
+        "xyz.openbmc_project.LED.Controller.status_amber",
+        "/xyz/openbmc_project/led/physical/status_amber",
+        "xyz.openbmc_project.Led.Physical", "State",
+        [aResp](const boost::system::error_code ec,
+                const std::string& amberLedState) {
+        if (ec)
+        {
+            BMCWEB_LOG_ERROR("Get Physical State Amber Led: DBus Error", ec);
+            messages::internalError(aResp->res);
+            return;
+        }
+        setPhysicalLedState(aResp, "AmberLED", amberLedState);
+    });
+
+    sdbusplus::asio::getProperty<std::string>(
+        *crow::connections::systemBus,
+        "xyz.openbmc_project.LED.Controller.status_green",
+        "/xyz/openbmc_project/led/physical/status_green",
+        "xyz.openbmc_project.Led.Physical", "State",
+        [aResp](const boost::system::error_code ec,
+                const std::string& greenLedState) {
+        if (ec)
+        {
+            BMCWEB_LOG_ERROR("Get Physical State Green Led: DBus Error", ec);
+            messages::internalError(aResp->res);
+            return;
+        }
+        setPhysicalLedState(aResp, "GreenLED", greenLedState);
+    });
+
+    sdbusplus::asio::getProperty<std::string>(
+        *crow::connections::systemBus,
+        "xyz.openbmc_project.LED.Controller.status_susack",
+        "/xyz/openbmc_project/led/physical/status_susack",
+        "xyz.openbmc_project.Led.Physical", "State",
+        [aResp](const boost::system::error_code ec,
+                const std::string& susackLedState) {
+        if (ec)
+        {
+            BMCWEB_LOG_ERROR("Get Physical State Susack Led: DBus Error", ec);
+            messages::internalError(aResp->res);
+            return;
+        }
+        setPhysicalLedState(aResp, "SusackLED", susackLedState);
+    });
+}
 } // namespace redfish
diff --git a/redfish-core/lib/systems.hpp b/redfish-core/lib/systems.hpp
index 40ea52b6..053d5efa 100644
--- a/redfish-core/lib/systems.hpp
+++ b/redfish-core/lib/systems.hpp
@@ -3520,6 +3520,7 @@ inline void
     getLocationIndicatorActive(asyncResp);
     // TODO (Gunnar): Remove IndicatorLED after enough time has passed
     getIndicatorLedState(asyncResp);
+    getPhysicalLedState(asyncResp);
     getComputerSystem(asyncResp, health);
     getHostState(asyncResp);
     getBootProperties(asyncResp);
-- 
2.34.1

