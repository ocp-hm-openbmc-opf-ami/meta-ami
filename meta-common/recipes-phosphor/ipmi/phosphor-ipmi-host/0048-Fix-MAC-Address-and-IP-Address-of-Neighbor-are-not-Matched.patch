From 73ff785f295182738f0844cd02abfd0b57edde6c Mon Sep 17 00:00:00 2001
From: Ethan Wei <ethanwei@ami.com>
Date: Tue, 22 Aug 2023 03:17:32 -0700
Subject: [PATCH] Fix MAC address and IP address are not matched and check if
 gateway and IP address are in the same subnet

---
 transporthandler.cpp | 10 ++++++++++
 transporthandler.hpp |  2 --
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/transporthandler.cpp b/transporthandler.cpp
index 7a99cbb..96232e9 100644
--- a/transporthandler.cpp
+++ b/transporthandler.cpp
@@ -1232,6 +1232,16 @@ RspType<> setLan(Context::ptr ctx, uint4_t channelBits, uint4_t reserved1,
                 return responseReqDataLenInvalid();
             }
             copyInto(gateway, bytes);
+            auto ifaddr = channelCall<getIfAddr4>(channel);
+            if (ifaddr)
+            {
+                auto addr = ifaddr->address;
+                auto netmask = prefixToNetmask(ifaddr->prefix);
+                if ((addr.s_addr & netmask.s_addr) != (gateway.s_addr & netmask.s_addr)) {
+                    return responseInvalidFieldRequest();
+                }
+            }
+
             channelCall<setGatewayProperty<AF_INET>>(channel, gateway);
             return responseSuccess();
         }
diff --git a/transporthandler.hpp b/transporthandler.hpp
index 378a2e9..d067f31 100644
--- a/transporthandler.hpp
+++ b/transporthandler.hpp
@@ -701,11 +701,9 @@ void setGatewayProperty(sdbusplus::bus_t& bus, const ChannelParams& params,
                     AddrFamily<family>::propertyGateway,
                     addrToString<family>(address));
 
-    // Restore the gateway MAC if we had one
     if (neighbor)
     {
         deleteObjectIfExists(bus, params.service, neighbor->path);
-        createNeighbor<family>(bus, params, address, neighbor->mac, neighbor->prefixLength);
     }
 }
 
-- 
2.25.1

