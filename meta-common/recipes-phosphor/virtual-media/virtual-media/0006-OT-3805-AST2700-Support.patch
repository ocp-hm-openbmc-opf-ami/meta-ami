From 59a64799b52acf9bcd18b93ff434807104a6befa Mon Sep 17 00:00:00 2001
From: Mohammed Javith Akthar M <mohammedjavitham@ami.com>
Date: Tue, 16 Apr 2024 15:30:27 +0530
Subject: [PATCH 6/6] OT-3805 AST2700 Support

AST2700 uses different vhub. This commit enables support for UDC
configuration.

Signed-off-by: Mohammed Javith Akthar M <mohammedjavitham@ami.com>
---
 src/system.hpp | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/src/system.hpp b/src/system.hpp
index e6d1cf8..9047c90 100644
--- a/src/system.hpp
+++ b/src/system.hpp
@@ -543,6 +543,10 @@ struct UsbGadget
         const fs::path configDir = gadgetDir / "configs/c.1";
         const fs::path massStorageDir = configDir / "mass_storage.usb0";
         const fs::path configStringsDir = configDir / "strings/0x409";
+        const std::string usbVirtualHub =
+            fs::exists("/sys/bus/platform/devices/12011000.usb-vhub")
+                ? "12011000" /* AST2700 */
+                : "1e6a0000";
 
         if (change == StateChange::inserted)
         {
@@ -605,12 +609,14 @@ struct UsbGadget
                     }
                 }
 
-                for (const auto& port : fs::directory_iterator(
-                         "/sys/bus/platform/devices/1e6a0000.usb-vhub"))
+                for (const auto& port :
+                     fs::directory_iterator("/sys/bus/platform/devices/" +
+                                            usbVirtualHub + ".usb-vhub"))
                 {
                     const std::string portId = port.path().filename();
 
-                    if (portId.find("1e6a0000.usb-vhub:p") != std::string::npos)
+                    if (portId.find(usbVirtualHub + ".usb-vhub:p") !=
+                        std::string::npos)
                     {
                         constexpr std::string_view portDelimiter = ":p";
                         const std::string portNumber = portId.substr(
-- 
2.34.1

