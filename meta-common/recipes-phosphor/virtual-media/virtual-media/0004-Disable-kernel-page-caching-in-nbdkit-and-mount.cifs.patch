From 0f188addc14e03ebebeb91a94da11e063248c438 Mon Sep 17 00:00:00 2001
From: Mohammed Javith Akthar M <mohammedjavitham@ami.com>
Date: Tue, 10 Oct 2023 18:08:19 +0530
Subject: [PATCH 4/4] Disable kernel page caching in nbdkit and mount.cifs

Issue:
In some platforms, when copying large media 9GB+ inside host,
kernel panic will happen inside BMC due to page alloc failure.

Fix:
Configured cache=none in nbdkit and mount.cifs

Signed-off-by: Mohammed Javith Akthar M <mohammedjavitham@ami.com>
---
 src/smb.hpp                    |  2 +-
 src/state/activating_state.cpp | 13 ++++++++-----
 2 files changed, 9 insertions(+), 6 deletions(-)

diff --git a/src/smb.hpp b/src/smb.hpp
index 9e4a2fc..b694d48 100644
--- a/src/smb.hpp
+++ b/src/smb.hpp
@@ -23,7 +23,7 @@ class SmbShare
     {
         LogMsg(Logger::Debug, "Trying to mount remote : ", remote);
 
-        const std::string params = "sec=ntlmsspi,seal";
+        const std::string params = "sec=ntlmsspi,seal,cache=none";
         const std::string perm = rw ? "rw" : "ro";
         std::string options = params + "," + perm;
         std::string credentialsOpt;
diff --git a/src/state/activating_state.cpp b/src/state/activating_state.cpp
index 37da28f..704ff20 100644
--- a/src/state/activating_state.cpp
+++ b/src/state/activating_state.cpp
@@ -288,11 +288,14 @@ std::unique_ptr<resource::Process>
     ActivatingState::spawnNbdKit(interfaces::MountPointStateMachine& machine,
                                  const fs::path& file)
 {
-    return spawnNbdKit(machine, {},
-                       {// Use file plugin ...
-                        "file",
-                        // ... to mount file at this location
-                        "file=" + file.string()});
+    std::vector<std::string> params = {// Use file plugin ...
+                                       "file",
+                                       // ... to mount file at this location
+                                       "file=" + file.string(),
+                                       // Disable kernel page caching
+                                       "cache=none"};
+
+    return spawnNbdKit(machine, {}, params);
 }
 
 std::unique_ptr<resource::Process>
-- 
2.34.1

