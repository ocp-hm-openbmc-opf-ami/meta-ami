From a31660e931565d98ad8139f274727dece87e12cc Mon Sep 17 00:00:00 2001
From: vipinc <vipinc@ami.com>
Date: Fri, 18 Nov 2022 15:12:15 +0530
Subject: [PATCH] Add Severity Information For Discrete Sensor

This commit will add proper severity message information and description
when Mail Alert is generated for Discrete Sensor.

Test:
-Tested and verified Alert message is proper for both threshold and
Discrete sensor.

Signed-off-by: vipinc <vipinc@ami.com>
---
 src/pef_action.cpp | 30 +++++++++++++++++++-----------
 1 file changed, 19 insertions(+), 11 deletions(-)

diff --git a/src/pef_action.cpp b/src/pef_action.cpp
index 2287815..3f82cab 100644
--- a/src/pef_action.cpp
+++ b/src/pef_action.cpp
@@ -113,6 +113,7 @@ static uint16_t sendSmtpAlert(std::string rec, struct EventMsgData* eveMsg,
     std::string sensorType = getSensorTypeStringFromPath(sensorPath.c_str());
     std::string sensorName;
     std::string severity;
+    uint8_t sensorEveType = (eveMsg->eventType & 0x7f);
     std::size_t found = sensorPath.find_last_of("/\\");
     sensorName = sensorPath.substr(found + 1);
     if (sensorName.empty())
@@ -126,19 +127,26 @@ static uint16_t sendSmtpAlert(std::string rec, struct EventMsgData* eveMsg,
 
     uint8_t evnDat = (eveMsg->eventData[0] & 0x0F);
     bool assert = (eveMsg->eventType & 0x80) ? false : true;
-
-    if (evnDat == 0x02 || evnDat == 0x09)
-    {
-        severity = "Critical";
-    }
-    else if (evnDat == 0x00 || evnDat == 0x07)
-    {
-        severity = "Warning";
+    if (sensorEveType != static_cast<uint8_t>(EventTypeCode::sensor_specific))
+    {
+	    if (evnDat == 0x02 || evnDat == 0x09)
+	    {
+	        severity = "Critical";
+	    }
+	    else if (evnDat == 0x00 || evnDat == 0x07)
+	    {
+	        severity = "Warning";
+	    }
+
+	    if (!assert)
+	    {
+	        severity = "Ok";
+	    }
     }
-
-    if (!assert)
+    else
     {
-        severity = "Ok";
+        // Initilize Severity for Discrete sensor
+        severity = "Information";
     }
 
     std::string eventDataMsg = "unknown event";
-- 
2.25.1

